(function(k,m){"function"===typeof define&&define.amd?define(["prismjs"],m):"object"===typeof exports?module.exports=m(require("prismjs")):k.mdEdit=m(k.Prism)})(this,function(k){function m(a,d,c,b){c=+c||0;b=b||"";return a.slice(0,d)+b+a.slice(d+c)}function r(a){this.elt=a}function t(a,d){if(!a)return null;var c=0,b=a;do{var e=b;if(b=b.firstChild){do{var f=b.textContent.length;if(c<=d&&c+f>d)break;c+=f}while(b=b.nextSibling)}if(!b)break}while(b&&b.hasChildNodes()&&3!=b.nodeType);if(b)return{element:b,
offset:d-c};if(e){for(b=e;b&&b.lastChild;)b=b.lastChild;return 3===b.nodeType?{element:b,offset:b.textContent.length}:{element:b,offset:0}}return{element:a,offset:0,error:!0}}function l(a){this.editor=a;this.undoStack=[];this.redoStack=[]}function h(a,d){if(!(this instanceof h))return new h(a,d);d=d||{};"PRE"===a.tagName?this.el=a:(this.el=document.createElement("pre"),a.appendChild(this.el));var c=d.className||"";this.el.className="mdedit"+(c?" "+c:"");this.el.setAttribute("contenteditable",!0);
this.selMgr=new r(a);this.undoMgr=new l(this);q.bind(a,"cut",this.cut.bind(this));q.bind(a,"paste",this.paste.bind(this));q.bind(a,"keyup",this.keyup.bind(this));q.bind(a,"input",this.changed.bind(this));q.bind(a,"keydown",this.keydown.bind(this));q.bind(a,"keypress",this.keypress.bind(this));this.changeCb=d.change||function(){};this.changed()}var u=function(){function a(a,d){e[a]=b[a]=c[a]=d}function d(a,b){e[a]=c[a]=b}var c={comment:k.languages.markup.comment},b={},e={},f={markup:["markup","html",
"xml"],javascript:["javascript","js"]},g;for(g in k.languages)if(k.languages.hasOwnProperty(g)){var h=k.languages[g];if("function"!==typeof h){var p=f[g],p=p?p.join("|"):g;d("code-block fenced "+g,{pattern:new RegExp("(^ {0,3}|\\n {0,3})(([`~])\\3\\3) *("+p+")( [^`\n]*)? *\\n(?:[\\s\\S]*?)\\n {0,3}(\\2\\3*(?= *\\n)|$)","gi"),lookbehind:!0,inside:{"code-language":{pattern:/(^([`~])\2+)((?!\2)[^\2\n])+/,lookbehind:!0},"marker code-fence start":/^([`~])\1+/,"marker code-fence end":/([`~])\1+$/,"code-inner":{pattern:/(^\n)[\s\S]*(?=\n$)/,
lookbehind:!0,alias:"language-"+g,inside:h}}})}}d("code-block fenced untagged",{pattern:/(^ {0,3}|\n {0,3})(([`~])\3\3)[^`\n]*\n(?:[\s\S]*?)\n {0,3}(\2\3*(?= *\n)|$)/g,lookbehind:!0,inside:{"code-language":{pattern:/(^([`~])\2+)((?!\2)[^\2\n])+/,lookbehind:!0},"marker code-fence start":/^([`~])\1+/,"marker code-fence end":/([`~])\1+$/,"code-inner":{pattern:/(^\n)[\s\S]*(?=\n$)/,lookbehind:!0}}});d("heading setext-heading heading-1",{pattern:/^ {0,3}[^\s].*\n {0,3}=+[ \t]*$/gm,inside:{"marker heading-setext-line":{pattern:/^( {0,3}[^\s].*\n) {0,3}=+[ \t]*$/gm,
lookbehind:!0},rest:b}});d("heading setext-heading heading-2",{pattern:/^ {0,3}[^\s].*\n {0,3}-+[ \t]*$/gm,inside:{"marker heading-setext-line":{pattern:/^( {0,3}[^\s].*\n) {0,3}-+[ \t]*$/gm,lookbehind:!0},rest:b}});f={"marker heading-hash start":/^ *#+ */,"marker heading-hash end":/ +#+ *$/,rest:b};for(g=1;6>=g;g+=1)d("heading heading-"+g,{pattern:new RegExp("^ {0,3}#{"+g+"}(?!#).*$","gm"),inside:f});g={pattern:/^\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,inside:{"marker bracket start":/^\[/,"marker bracket end":/\]$/,
"link-text-inner":{pattern:/[\w\W]+/,inside:b}}};var f={pattern:/\[(?:\\.|[^\]])*\]/,inside:{"marker bracket start":/^\[/,"marker bracket end":/\]$/,"link-label-inner":/[\w\W]+/}},h={pattern:/^!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,inside:{"marker image-bang":/^!/,"marker bracket start":/^\[/,"marker bracket end":/\]$/,"image-text-inner":{pattern:/[\w\W]+/,inside:b}}},p={pattern:/^(\s*)(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))+/,lookbehind:!0},l={pattern:/^(\s*)<(?:\\.|[^<>\n])*>/,lookbehind:!0,inside:{"marker brace start":/^</,
"marker brace end":/>$/,"braced-href-inner":/[\w\W]+/}},m={pattern:/('(?:\\'|[^'])+'|"(?:\\"|[^"])+")\s*$/,inside:{"marker quote start":/^['"]/,"marker quote end":/['"]$/,"title-inner":/[\w\W]+/}},n={pattern:/\( *(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)( +('(?:[^']|\\')+'|"(?:[^"]|\\")+"))? *\)/,inside:{"marker bracket start":/^\(/,"marker bracket end":/\)$/,"link-params-inner":{pattern:/[\w\W]+/,inside:{"link-title":m,href:p,"braced-href":l}}}};d("hr",{pattern:/^[\t ]*([*\-_])([\t ]*\1){2,}([\t ]*$)/gm,
inside:{"marker hr-marker":/[*\-_]/g}});d("urldef",{pattern:/^( {0,3})\[(?:\\.|[^\]])+]: *\n? *(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)( *\n? *('(?:\\'|[^'])+'|"(?:\\"|[^"])+"))?$/gm,lookbehind:!0,inside:{"link-label":f,"marker urldef-colon":/^:/,"link-title":m,href:p,"braced-href":l}});d("blockquote",{pattern:/^[\t ]*>[\t ]?.+(?:\n(?!\n)|.)*/gm,inside:{"marker quote-marker":/^[\t ]*>[\t ]?/gm,"blockquote-content":{pattern:/[^>]+/,rest:e}}});d("list",{pattern:/^[\t ]*([*+\-]|\d+\.)[\t ].+(?:\n(?!\n)|.)*/gm,
inside:{li:{pattern:/^[\t ]*([*+\-]|\d+\.)[\t ].+(?:\n|[ \t]+[^*+\- \t].*\n)*/gm,inside:{"marker list-item":/^[ \t]*([*+\-]|\d+\.)[ \t]/m,rest:e}}}});d("code-block indented",{pattern:/(^|(?:^|(?:^|\n)(?![ \t]*([*+\-]|\d+\.)[ \t]).*\n)\s*?\n)((?: {4}|\t).*(?:\n|$))+/g,lookbehind:!0});d("p",{pattern:/[^\n](?:\n(?!\n)|.)*[^\n]/g,inside:b});a("image",{pattern:/(^|[^\\])!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]\(\s*(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)(\s+('(?:[^']|\\')+'|"(?:[^"]|\\")+"))?\s*\)/,
lookbehind:!0,inside:{"link-text":h,"link-params":n}});a("link",{pattern:/(^|[^\\])\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]\(\s*(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)(\s+('(?:[^']|\\')+'|"(?:[^"]|\\")+"))?\s*\)/,lookbehind:!0,inside:{"link-text":g,"link-params":n}});a("image image-ref",{pattern:/(^|[^\\])!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\] ?\[(?:\\.|[^\]])*\]/,lookbehind:!0,inside:{"link-text":h,"link-label":f}});a("link link-ref",{pattern:/(^|[^\\])\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\] ?\[(?:\\.|[^\]])*\]/,
lookbehind:!0,inside:{"link-text":g,"link-label":f}});a("image image-ref shortcut-ref",{pattern:/(^|[^\\])!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,lookbehind:!0,inside:{"marker image-bang":/^!/,"link-text":g}});a("link link-ref shortcut-ref",{pattern:/(^|[^\\])\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,lookbehind:!0,inside:{"link-text":g}});a("code",{pattern:/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/g,lookbehind:!0,inside:{"marker code-marker start":/^`/,"marker code-marker end":/`$/,"code-inner":/[\w\W]+/}});a("strong",
{pattern:/(^|[^\\*_]|\\[*_])([_\*])\2(?:\n(?!\n)|.)+?\2{2}(?!\2)/g,lookbehind:!0,inside:{"marker strong-marker start":/^(\*\*|__)/,"marker strong-marker end":/(\*\*|__)$/,"strong-inner":{pattern:/[\w\W]+/,inside:b}}});a("em",{pattern:/(^|[^\\*_]|\\[*_])(\*|_)(?:\n(?!\n)|.)+?\2(?!\2)/g,lookbehind:!0,inside:{"marker em-marker start":/^(\*|_)/,"marker em-marker end":/(\*|_)$/,"em-inner":{pattern:/[\w\W]+/,inside:b}}});a("strike",{pattern:/(^|\n|(?!\\)\W)(~~)(?=\S)([^\r]*?\S)\2/gm,lookbehind:!0,inside:{"marker strike-marker start":/^~~/,
"marker strike-marker end":/~~$/,"strike-inner":{pattern:/[\w\W]+/,inside:b}}});a("comment",k.languages.markup.comment);g=k.languages.markup.tag;a("tag",{pattern:new RegExp("(^|[^\\\\])"+g.pattern.source,"i"),lookbehind:!0,inside:g.inside});a("entity",k.languages.markup.entity);return c}(),q={bind:function(a,d,c){a.addEventListener(d,c,!1)}},v={newline:function(a,d){var c=a.start,b=a.before.lastIndexOf("\n")+1,e=a.before.slice(b),b=e.match(/^\s*/)[0],f="";/^ {0,3}$/.test(b)&&(e=e.slice(b.length),
/^[*+\-]\s+/.test(e)?f+=e.match(/^[*+\-]\s+/)[0]:/^\d+\.\s+/.test(e)?f+=e.match(/^\d+\.\s+/)[0].replace(/^\d+/,function(a){return+a+1}):/^>/.test(e)&&(f+=e.match(/^>\s*/)[0]));b+=f;a.before+="\n"+b;f=a.sel;a.sel="";a.start+=1+b.length;a.end=a.start;return{add:"\n"+b,del:f,start:c}},indent:function(a,d){var c=a.before.lastIndexOf("\n")+1;if(d.inverse)/\s/.test(a.before.charAt(c))&&(a.before=m(a.before,c,1),--a.start),a.sel=a.sel.replace(/\r?\n(?!\r?\n)\s/,"\n");else if(a.sel||d.ctrl)a.before=m(a.before,
c,0,"\t"),a.sel=a.sel.replace(/\r?\n/,"\n\t"),a.start+=1;else return a.before+="\t",a.start+=1,a.end+=1,{add:"\t",del:"",start:a.start-1};a.end=a.start+a.sel.length;return{action:"indent",start:a.start,end:a.end,inverse:d.inverse}}};r.prototype.getStart=function(){var a=getSelection();if(!a.rangeCount)return 0;var d=a.getRangeAt(0),c=a=d.startContainer,d=d.startOffset;if(!(this.elt.compareDocumentPosition(a)&16))return 0;do{for(;a=a.previousSibling;)a.textContent&&(d+=a.textContent.length);a=c=c.parentNode}while(a&&
a!==this.elt);return d};r.prototype.getEnd=function(){var a=getSelection();return a.rangeCount?this.getStart()+String(a.getRangeAt(0)).length:0};r.prototype.setRange=function(a,d,c){var b=document.createRange(),e=t(this.elt,a),f=e;d&&d!==a&&(f=t(this.elt,d));if(!1!==c){a=f.element;var g=f.offset;d=a.textContent;c=a.parentNode;var h=d.slice(0,g),g=d.slice(g);a.textContent=g;h=document.createTextNode(h);c.insertBefore(n,a);c.insertBefore(h,n);var g=n.offsetTop,k=n.offsetHeight,l=this.elt.offsetHeight,
m=this.elt.scrollTop;a.textContent=d;c.removeChild(n);c.removeChild(h);0>g-m?this.elt.scrollTop=g:g-m+k>l&&(this.elt.scrollTop=g+k-l)}b.setStart(e.element,e.offset);b.setEnd(f.element,f.offset);e=getSelection();e.removeAllRanges();e.addRange(b)};var n=document.createElement("span");n.style.position="absolute";n.innerHTML="|";l.prototype.action=function(a){this.undoStack.length&&this.canCombine(this.undoStack[this.undoStack.length-1],a)?this.undoStack.push(this.combine(this.undoStack.pop(),a)):this.undoStack.push(a);
this.redoStack=[]};l.prototype.canCombine=function(a,d){return!a.action&&!d.action&&!Array.isArray(a)&&!Array.isArray(d)&&!(a.del&&d.add)&&!(a.add&&d.del)&&!(a.add&&!d.add)&&!(!a.add&&d.add)&&!(a.add&&a.del)&&!(d.add&&d.del)&&a.start+a.add.length===d.start+d.del.length};l.prototype.combine=function(a,d){return{add:a.add+d.add,del:d.del+a.del,start:Math.min(a.start,d.start)}};l.prototype.undo=function(){if(this.undoStack.length){var a=this.undoStack.pop();this.redoStack.push(a);this.applyInverse(a)}};
l.prototype.redo=function(){if(this.redoStack.length){var a=this.redoStack.pop();this.undoStack.push(a);this.apply(a)}};l.prototype.apply=function d(c){Array.isArray(c)?c.forEach(d.bind(this)):c.action?this.editor.action(c.action,{inverse:c.inverse,start:c.start,end:c.end,noHistory:!0}):this.editor.apply(c)};l.prototype.applyInverse=function c(b){Array.isArray(b)?b.forEach(c.bind(this)):b.action?this.editor.action(b.action,{inverse:!b.inverse,start:b.start,end:b.end,noHistory:!0}):this.editor.apply({start:b.start,
end:b.end,del:b.add,add:b.del})};h.prototype.fireChange=function(){var c=this._prevValue,b=this.getValue();c!==b&&(this.changeCb(b),this._prevValue=b)};h.prototype.setValue=function(c){this.el.textContent=c;this.changed()};h.prototype.getValue=function(){return this.el.textContent};h.prototype.keyup=function(c){c=c&&c.keyCode||0;-1<[9,91,93,16,17,18,20,13,112,113,114,115,116,117,118,119,120,121,122,123,27].indexOf(c)||-1===[37,39,38,40].indexOf(c)&&this.changed()};h.prototype.changed=function(c){c=
this.el.textContent;var b=this.selMgr.getStart(),e=this.selMgr.getEnd();this.saveScrollPos();this.el.innerHTML=k.highlight(c,u);/\n$/.test(c)||(this.el.innerHTML+="\n");this.restoreScrollPos();null===b&&null===e||this.selMgr.setRange(b,e);this.fireChange()};h.prototype.saveScrollPos=function(){void 0===this.st&&(this.st=this.el.scrollTop);setTimeout(function(){this.st=void 0}.bind(this),500)};h.prototype.restoreScrollPos=function(){this.el.scrollTop=this.st;this.st=void 0};h.prototype.keypress=function(c){if(!c.metaKey&&
!c.ctrlKey){var b=c.charCode;if(b){c=this.selMgr.getStart();var e=this.selMgr.getEnd(),b=String.fromCharCode(b);this.undoMgr.action({add:b,del:c===e?"":this.el.textContent.slice(c,e),start:c})}}};h.prototype.keydown=function(c){var b=c.metaKey||c.ctrlKey;switch(c.keyCode){case 8:case 46:var b=this.selMgr.getStart(),e=this.selMgr.getEnd(),f=b===e?1:Math.abs(e-b),b=8===c.keyCode?e-f:b;this.undoMgr.action({add:"",del:this.el.textContent.slice(b,b+f),start:b});break;case 9:b||(this.action("indent",{inverse:c.shiftKey}),
c.preventDefault());break;case 219:case 221:b&&!c.shiftKey&&(this.action("indent",{inverse:219===c.keyCode,ctrl:!0}),c.preventDefault());break;case 13:this.action("newline");c.preventDefault();break;case 89:b&&(this.undoMgr.redo(),c.preventDefault());break;case 90:b&&(c.shiftKey?this.undoMgr.redo():this.undoMgr.undo(),c.preventDefault())}};h.prototype.apply=function(c){var b=this.el;b.textContent=m(b.textContent,c.start,c.del.length,c.add);this.selMgr.setRange(c.start,c.start+c.add.length);this.changed()};
h.prototype.action=function(c,b){b=b||{};var e=this.el.textContent,f=b.start||this.selMgr.getStart(),g=b.end||this.selMgr.getEnd(),e={start:f,end:g,before:e.slice(0,f),after:e.slice(g),sel:e.slice(f,g)},f=v[c](e,b);this.saveScrollPos();this.el.textContent=e.before+e.sel+e.after;f&&!b.noHistory&&this.undoMgr.action(f);this.selMgr.setRange(e.start,e.end,!1);this.changed()};h.prototype.cut=function(){var c=this.selMgr.getStart(),b=this.selMgr.getEnd();c!==b&&this.undoMgr.action({add:"",del:this.el.textContent.slice(c,
b),start:c})};h.prototype.paste=function(c){var b=this.selMgr.getStart(),e=this.selMgr.getEnd(),e=b===e?"":this.el.textContent.slice(b,e);c.clipboardData&&(c.preventDefault(),c=c.clipboardData.getData("text/plain"),this.apply({add:c,del:e,start:b}),this.undoMgr.action({add:c,del:e,start:b}),b+=c.length,this.selMgr.setRange(b,b),this.changed())};return h});
