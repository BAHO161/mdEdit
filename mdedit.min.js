!function(t,e){"function"==typeof define&&define.amd?define(["prismjs"],e):"object"==typeof exports?module.exports=e(require("prismjs")):t.mdEdit=e(t.Prism)}(this,function(t){function e(t,e,n,r){return n=+n||0,r=r||"",t.slice(0,e)+r+t.slice(e+n)}function n(t){this.elt=t}function r(t,e){var n=t.textContent,r=t.parentNode,i=n.slice(0,e),a=n.slice(e);t.textContent=a;var s=document.createTextNode(i);r.insertBefore(c,t),r.insertBefore(s,c);var o=c.offsetTop,d=c.offsetHeight,l=this.elt.offsetHeight,h=this.elt.scrollTop;t.textContent=n,r.removeChild(c),r.removeChild(s),0>o-h?this.elt.scrollTop=o:o-h+d>l&&(this.elt.scrollTop=o+d-l)}function i(t,e){if(!t)return null;var n=0,r=t;do{var i=r;if(r=r.firstChild)do{var a=r.textContent.length;if(e>=n&&n+a>e)break;n+=a}while(r=r.nextSibling);if(!r)break}while(r&&r.hasChildNodes()&&3!=r.nodeType);if(r)return{element:r,offset:e-n};if(i){for(r=i;r&&r.lastChild;)r=r.lastChild;return 3===r.nodeType?{element:r,offset:r.textContent.length}:{element:r,offset:0}}return{element:t,offset:0,error:!0}}function a(t){this.editor=t,this.undoStack=[],this.redoStack=[]}function s(t,e){if(!(this instanceof s))return new s(t,e);e=e||{},"PRE"===t.tagName?this.el=t:(this.el=document.createElement("pre"),t.appendChild(this.el));var r=e.className||"";this.el.className="mdedit"+(r?" "+r:""),this.el.setAttribute("contenteditable",!0),this.selMgr=new n(t),this.undoMgr=new a(this),l.bind(t,"cut",this.cut.bind(this)),l.bind(t,"paste",this.paste.bind(this)),l.bind(t,"keyup",this.keyup.bind(this)),l.bind(t,"input",this.changed.bind(this)),l.bind(t,"keydown",this.keydown.bind(this)),l.bind(t,"keypress",this.keypress.bind(this));var i=e.change;this.changeCb=i||function(){},this.changed()}var o={scalar:{pattern:/([\-:]\s*(![^\s]+)?[ \t]*[|>])[ \t]*(?:(\n[ \t]+)[^\r\n]+(?:\3[^\r\n]+)*)/,lookbehind:!0,alias:"string"},comment:/#[^\n]+/,key:{pattern:/(\s*[:\-,[{\n?][ \t]*(![^\s]+)?[ \t]*)[^\n{[\]},#]+?(?=\s*:\s)/,lookbehind:!0,alias:"atrule"},directive:{pattern:/((^|\n)[ \t]*)%[^\n]+/,lookbehind:!0,alias:"important"},datetime:{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)(\d{4}-\d\d?-\d\d?([tT]|[ \t]+)\d\d?:\d{2}:\d{2}(\.\d*)?[ \t]*(Z|[-+]\d\d?(:\d{2})?)?|\d{4}-\d{2}-\d{2}|\d\d?:\d{2}(:\d{2}(\.\d*)?)?)(?=[ \t]*(\n|$|,|]|}))/,lookbehind:!0,alias:"number"},"boolean":{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)(true|false)[ \t]*(?=\n|$|,|]|})/i,lookbehind:!0,alias:"important"},"null":{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)(null|~)[ \t]*(?=\n|$|,|]|})/i,lookbehind:!0,alias:"important"},string:{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)("(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*')(?=[ \t]*(\n|$|,|]|}))/,lookbehind:!0},number:{pattern:/([:\-,[{]\s*(![^\s]+)?[ \t]*)[+\-]?(0x[\dA-Fa-f]+|0o[0-7]+|(\d+\.?\d*|\.?\d+)(e[\+\-]?\d+)?|\.inf|\.nan)[ \t]*(?=\n|$|,|]|})/i,lookbehind:!0},tag:/![^\s]+/,important:/[&*][\w]+/,punctuation:/([:[\]{}\-,|>?]|---|\.\.\.)/},d=function(){function e(t,e){a[t]=i[t]=r[t]=e}function n(t,e){a[t]=r[t]=e}var r={comment:t.languages.markup.comment};r["front-matter"]={pattern:/^---\n[\s\S]*?\n---(?=\n|$)/,inside:{"marker front-matter-marker start":/^---/,"marker front-matter-marker end":/---$/,rest:o}};var i={},a={},s={markup:["markup","html","xml"],javascript:["javascript","js"]};for(var d in t.languages)if(t.languages.hasOwnProperty(d)){var l=t.languages[d];if("function"!=typeof l){var h=s[d],c=h?h.join("|"):d;n("code-block fenced "+d,{pattern:new RegExp("(^ {0,3}|\\n {0,3})(([`~])\\3\\3) *("+c+")( [^`\n]*)? *\\n(?:[\\s\\S]*?)\\n {0,3}(\\2\\3*(?= *\\n)|$)","gi"),lookbehind:!0,inside:{"code-language":{pattern:/(^([`~])\2+)((?!\2)[^\2\n])+/,lookbehind:!0},"marker code-fence start":/^([`~])\1+/,"marker code-fence end":/([`~])\1+$/,"code-inner":{pattern:/(^\n)[\s\S]*(?=\n$)/,lookbehind:!0,alias:"language-"+d,inside:l}}})}}n("code-block fenced untagged",{pattern:/(^ {0,3}|\n {0,3})(([`~])\3\3)[^`\n]*\n(?:[\s\S]*?)\n {0,3}(\2\3*(?= *\n)|$)/g,lookbehind:!0,inside:{"code-language":{pattern:/(^([`~])\2+)((?!\2)[^\2\n])+/,lookbehind:!0},"marker code-fence start":/^([`~])\1+/,"marker code-fence end":/([`~])\1+$/,"code-inner":{pattern:/(^\n)[\s\S]*(?=\n$)/,lookbehind:!0}}}),n("heading setext-heading heading-1",{pattern:/^ {0,3}[^\s].*\n {0,3}=+[ \t]*$/gm,inside:{"marker heading-setext-line":{pattern:/^( {0,3}[^\s].*\n) {0,3}=+[ \t]*$/gm,lookbehind:!0},rest:i}}),n("heading setext-heading heading-2",{pattern:/^ {0,3}[^\s].*\n {0,3}-+[ \t]*$/gm,inside:{"marker heading-setext-line":{pattern:/^( {0,3}[^\s].*\n) {0,3}-+[ \t]*$/gm,lookbehind:!0},rest:i}});for(var p={"marker heading-hash start":/^ *#+ */,"marker heading-hash end":/ +#+ *$/,rest:i},d=1;6>=d;d+=1)n("heading heading-"+d,{pattern:new RegExp("^ {0,3}#{"+d+"}(?![#\\S]).*$","gm"),inside:p});var g={pattern:/^\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,inside:{"marker bracket start":/^\[/,"marker bracket end":/\]$/,"link-text-inner":{pattern:/[\w\W]+/,inside:i}}},k={pattern:/\[(?:\\.|[^\]])*\]/,inside:{"marker bracket start":/^\[/,"marker bracket end":/\]$/,"link-label-inner":/[\w\W]+/}},f={pattern:/^!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,inside:{"marker image-bang":/^!/,"marker bracket start":/^\[/,"marker bracket end":/\]$/,"image-text-inner":{pattern:/[\w\W]+/,inside:i}}},u={pattern:/^(\s*)(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))+/,lookbehind:!0},m={pattern:/^(\s*)<(?:\\.|[^<>\n])*>/,lookbehind:!0,inside:{"marker brace start":/^</,"marker brace end":/>$/,"braced-href-inner":/[\w\W]+/}},b={pattern:/('(?:\\'|[^'])+'|"(?:\\"|[^"])+")\s*$/,inside:{"marker quote start":/^['"]/,"marker quote end":/['"]$/,"title-inner":/[\w\W]+/}},v={pattern:/\( *(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)( +('(?:[^']|\\')+'|"(?:[^"]|\\")+"))? *\)/,inside:{"marker bracket start":/^\(/,"marker bracket end":/\)$/,"link-params-inner":{pattern:/[\w\W]+/,inside:{"link-title":b,href:u,"braced-href":m}}}};n("hr",{pattern:/^[\t ]*([*\-_])([\t ]*\1){2,}([\t ]*$)/gm,inside:{"marker hr-marker":/[*\-_]/g}}),n("urldef",{pattern:/^( {0,3})\[(?:\\.|[^\]])+]: *\n? *(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)( *\n? *('(?:\\'|[^'])+'|"(?:\\"|[^"])+"))?$/gm,lookbehind:!0,inside:{"link-label":k,"marker urldef-colon":/^:/,"link-title":b,href:u,"braced-href":m}}),n("blockquote",{pattern:/^[\t ]*>[\t ]?.+(?:\n(?!\n)|.)*/gm,inside:{"marker quote-marker":/^[\t ]*>[\t ]?/gm,"blockquote-content":{pattern:/[^>]+/,inside:{rest:a}}}}),n("list",{pattern:/^[\t ]*([*+\-]|\d+\.)[\t ].+(?:\n(?!\n)|.)*/gm,inside:{li:{pattern:/^[\t ]*([*+\-]|\d+\.)[\t ].+(?:\n|[ \t]+[^*+\- \t].*\n)*/gm,inside:{"marker list-item":/^[ \t]*([*+\-]|\d+\.)[ \t]/m,rest:a}}}}),n("code-block indented",{pattern:/(^|(?:^|(?:^|\n)(?![ \t]*([*+\-]|\d+\.)[ \t]).*\n)\s*?\n)((?: {4}|\t).*(?:\n|$))+/g,lookbehind:!0}),n("p",{pattern:/[^\n](?:\n(?!\n)|.)*[^\n]/g,inside:i}),e("image",{pattern:/(^|[^\\])!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]\(\s*(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)(\s+('(?:[^']|\\')+'|"(?:[^"]|\\")+"))?\s*\)/,lookbehind:!0,inside:{"link-text":f,"link-params":v}}),e("link",{pattern:/(^|[^\\])\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]\(\s*(?:(?!<)(?:\\.|[^\(\)\s]|\([^\(\)\s]*\))*|<(?:[^<>\n]|\\.)*>)(\s+('(?:[^']|\\')+'|"(?:[^"]|\\")+"))?\s*\)/,lookbehind:!0,inside:{"link-text":g,"link-params":v}}),e("image image-ref",{pattern:/(^|[^\\])!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\] ?\[(?:\\.|[^\]])*\]/,lookbehind:!0,inside:{"link-text":f,"link-label":k}}),e("link link-ref",{pattern:/(^|[^\\])\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\] ?\[(?:\\.|[^\]])*\]/,lookbehind:!0,inside:{"link-text":g,"link-label":k}}),e("image image-ref shortcut-ref",{pattern:/(^|[^\\])!\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,lookbehind:!0,inside:{"marker image-bang":/^!/,"link-text":g}}),e("link link-ref shortcut-ref",{pattern:/(^|[^\\])\[(?:\\.|[^\[\]]|\[[^\[\]]*\])*\]/,lookbehind:!0,inside:{"link-text":g}}),e("code",{pattern:/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/g,lookbehind:!0,inside:{"marker code-marker start":/^`/,"marker code-marker end":/`$/,"code-inner":/[\w\W]+/}}),e("strong",{pattern:/(^|[^\\*_]|\\[*_])([_\*])\2(?:\n(?!\n)|.)+?\2{2}(?!\2)/g,lookbehind:!0,inside:{"marker strong-marker start":/^(\*\*|__)/,"marker strong-marker end":/(\*\*|__)$/,"strong-inner":{pattern:/[\w\W]+/,inside:i}}}),e("em",{pattern:/(^|[^\\*_]|\\[*_])(\*|_)(?:\n(?!\n)|.)+?\2(?!\2)/g,lookbehind:!0,inside:{"marker em-marker start":/^(\*|_)/,"marker em-marker end":/(\*|_)$/,"em-inner":{pattern:/[\w\W]+/,inside:i}}}),e("strike",{pattern:/(^|\n|(?!\\)\W)(~~)(?=\S)([^\r]*?\S)\2/gm,lookbehind:!0,inside:{"marker strike-marker start":/^~~/,"marker strike-marker end":/~~$/,"strike-inner":{pattern:/[\w\W]+/,inside:i}}}),e("comment",t.languages.markup.comment);var y=t.languages.markup.tag,x=y.pattern;return e("tag",{pattern:new RegExp("(^|[^\\\\])"+x.source,"i"),lookbehind:!0,inside:y.inside}),e("entity",t.languages.markup.entity),r}(),l={bind:function(t,e,n){t.addEventListener(e,n,!1)}},h={newline:function(t,e){var n=t.start,r=t.before.lastIndexOf("\n")+1,i=t.before.slice(r),a=i.match(/^\s*/)[0],s=a,o=!1;if(/^ {0,3}$/.test(a)){var d=i.slice(a.length);/^[*+\-]\s+/.test(d)?(s+=d.match(/^[*+\-]\s+/)[0],o=/^[*+\-]\s+$/.test(d)):/^\d+\.\s+/.test(d)?(s+=d.match(/^\d+\.\s+/)[0].replace(/^\d+/,function(t){return+t+1}),o=/^\d+\.\s+$/.test(d)):/^>/.test(d)&&(s+=d.match(/^>\s*/)[0],o=/^>\s*$/.test(d))}s="\n"+s;var l=t.sel;return t.sel="",o&&(l=i+l,t.before=t.before.slice(0,r),t.start-=i.length,n-=i.length,s="\n"),t.before+=s,t.start+=s.length,t.end=t.start,{add:s,del:l,start:n}},indent:function(t,n){var r=t.before.lastIndexOf("\n")+1;if(n.inverse)/\s/.test(t.before.charAt(r))&&(t.before=e(t.before,r,1),t.start-=1),t.sel=t.sel.replace(/\r?\n(?!\r?\n)\s/,"\n");else{if(!t.sel&&!n.ctrl)return t.before+="	",t.start+=1,t.end+=1,{add:"	",del:"",start:t.start-1};t.before=e(t.before,r,0,"	"),t.sel=t.sel.replace(/\r?\n/,"\n	"),t.start+=1}return t.end=t.start+t.sel.length,{action:"indent",start:t.start,end:t.end,inverse:n.inverse}},wrap:function(t,e){var n={"(":")","[":"]","{":"}","<":">"}[e.bracket]||e.bracket;return t.before+=e.bracket,t.after=n+t.after,t.start+=1,t.end+=1,{add:e.bracket+t.sel+n,del:t.sel,start:t.start-1,end:t.end-1}}};n.prototype.getStart=function(){var t=getSelection();if(!t.rangeCount)return 0;var e=t.getRangeAt(0),n=e.startContainer,r=n,i=e.startOffset;if(!(16&this.elt.compareDocumentPosition(n)))return 0;do{for(;n=n.previousSibling;)n.textContent&&(i+=n.textContent.length);n=r=r.parentNode}while(n&&n!==this.elt);return i},n.prototype.getEnd=function(){var t=getSelection();return t.rangeCount?this.getStart()+String(t.getRangeAt(0)).length:0},n.prototype.setRange=function(t,e,n){var a=document.createRange(),s=i(this.elt,t),o=s;e&&e!==t?o=i(this.elt,e):n!==!1&&r.call(this,o.element,o.offset),a.setStart(s.element,s.offset),a.setEnd(o.element,o.offset);var d=getSelection();d.removeAllRanges(),d.addRange(a)};var c=document.createElement("span");return c.style.position="absolute",c.innerHTML="|",a.prototype.action=function(t){this.undoStack.length&&this.canCombine(this.undoStack[this.undoStack.length-1],t)?this.undoStack.push(this.combine(this.undoStack.pop(),t)):this.undoStack.push(t),this.redoStack=[]},a.prototype.canCombine=function(t,e){return!(t.action||e.action||Array.isArray(t)||Array.isArray(e)||t.del&&e.add||t.add&&e.del||t.add&&!e.add||!t.add&&e.add||t.add&&t.del||e.add&&e.del||t.start+t.add.length!==e.start+e.del.length)},a.prototype.combine=function(t,e){return{add:t.add+e.add,del:e.del+t.del,start:Math.min(t.start,e.start)}},a.prototype.undo=function(){if(this.undoStack.length){var t=this.undoStack.pop();this.redoStack.push(t),this.applyInverse(t)}},a.prototype.redo=function(){if(this.redoStack.length){var t=this.redoStack.pop();this.undoStack.push(t),this.apply(t)}},a.prototype.apply=function p(t){return Array.isArray(t)?void t.forEach(p.bind(this)):void(t.action?this.editor.action(t.action,{inverse:t.inverse,start:t.start,end:t.end,noHistory:!0}):this.editor.apply(t))},a.prototype.applyInverse=function g(t){return Array.isArray(t)?void t.forEach(g.bind(this)):void(t.action?this.editor.action(t.action,{inverse:!t.inverse,start:t.start,end:t.end,noHistory:!0}):this.editor.apply({start:t.start,end:t.end,del:t.add,add:t.del}))},s.prototype.fireChange=function(){var t=this._prevValue,e=this.getValue();t!==e&&(this.changeCb(e),this._prevValue=e)},s.prototype.setValue=function(t){this.el.textContent=t,this.changed()},s.prototype.getValue=function(){return this.el.textContent},s.prototype.keyup=function(t){var e=t&&t.keyCode||0;this.el.textContent;[9,91,93,16,17,18,20,13,112,113,114,115,116,117,118,119,120,121,122,123,27].indexOf(e)>-1||-1===[33,34,35,36,37,39,38,40].indexOf(e)&&this.changed()},s.prototype.changed=function(e){var n=this.el.textContent,r=this.selMgr.getStart(),i=this.selMgr.getEnd();this.saveScrollPos(),n===this._prevCode?this.el.innerHTML!==this._prevHTML&&(this.el.innerHTML=this._prevHTML):this._prevHTML=this.el.innerHTML=t.highlight(n,d),this._prevCode=n,/\n$/.test(n)||(this.el.innerHTML=this.el.innerHTML+"\n"),this.restoreScrollPos(),(null!==r||null!==i)&&this.selMgr.setRange(r,i),this.fireChange()},s.prototype.saveScrollPos=function(){void 0===this.st&&(this.st=this.el.scrollTop),setTimeout(function(){this.st=void 0}.bind(this),500)},s.prototype.restoreScrollPos=function(){this.el.scrollTop=this.st,this.st=void 0},s.prototype.keypress=function(t){var e=t.metaKey||t.ctrlKey;if(!e){var n=t.charCode;if(n){var r=this.selMgr.getStart(),i=this.selMgr.getEnd(),a=String.fromCharCode(n);return/[\[\{\(<"'~\*_]/.test(a)&&r!==i?(this.action("wrap",{bracket:a}),void t.preventDefault()):void this.undoMgr.action({add:a,del:r===i?"":this.el.textContent.slice(r,i),start:r})}}},s.prototype.keydown=function(t){var e=t.metaKey||t.ctrlKey;switch(t.keyCode){case 8:case 46:var n=this.selMgr.getStart(),r=this.selMgr.getEnd(),i=n===r?1:Math.abs(r-n);n=8===t.keyCode?r-i:n,this.undoMgr.action({add:"",del:this.el.textContent.slice(n,n+i),start:n});break;case 9:e||(this.action("indent",{inverse:t.shiftKey}),t.preventDefault());break;case 219:case 221:e&&!t.shiftKey&&(this.action("indent",{inverse:219===t.keyCode,ctrl:!0}),t.preventDefault());break;case 13:this.action("newline"),t.preventDefault();break;case 89:e&&(this.undoMgr.redo(),t.preventDefault());break;case 90:e&&(t.shiftKey?this.undoMgr.redo():this.undoMgr.undo(),t.preventDefault());break;case 191:}},s.prototype.apply=function(t){var n=this.el;n.textContent=e(n.textContent,t.start,t.del.length,t.add),this.selMgr.setRange(t.start,t.start+t.add.length),this.changed()},s.prototype.action=function(t,e){e=e||{};var n=this.el.textContent,r=e.start||this.selMgr.getStart(),i=e.end||this.selMgr.getEnd(),a={start:r,end:i,before:n.slice(0,r),after:n.slice(i),sel:n.slice(r,i)},s=h[t](a,e);this.saveScrollPos(),this.el.textContent=a.before+a.sel+a.after,s&&!e.noHistory&&this.undoMgr.action(s),this.selMgr.setRange(a.start,a.end,!1),this.changed()},s.prototype.cut=function(){var t=this.selMgr.getStart(),e=this.selMgr.getEnd();t!==e&&this.undoMgr.action({add:"",del:this.el.textContent.slice(t,e),start:t})},s.prototype.paste=function(t){var e=this.selMgr.getStart(),n=this.selMgr.getEnd(),r=e===n?"":this.el.textContent.slice(e,n);if(t.clipboardData){t.preventDefault();var i=t.clipboardData.getData("text/plain");this.apply({add:i,del:r,start:e}),this.undoMgr.action({add:i,del:r,start:e}),e+=i.length,this.selMgr.setRange(e,e),this.changed()}},s});